# The Platform

The platform provides application developers with abstract RESTful interface to their applications and its resources. Any device that needs to interact with the others could be mapped to a resource on the platform. This mapping binds the data generated by the device to the state of the resource. Therefore, whenever a new data generated on the device, it should be sync to the platform so as to update resources state. In turn, this data could be used by other devices through the endpoint that expose the resource to external usages. In other words, every device has a corresponding API endpoint on the platform which is a RESTful abstraction for the device itself.
In addition to the device abstractions, defining rule-based events for every resource is made possible by the platform. An event has a condition which determines when the event occurs. Conditions are defined via a simple syntax, which is explained further in this section. Moreover, any clients that has access to the resource and its events could subscribe to the events with a notification/web-hook URL to be called when the event occurs. The platform notifies all the subscribers in case of an event occurrence through their web-hooks.

![Overall Design](http://dirtybit.github.io/resources/things-on-web/overall-diagram.png)

Above, figure shows the overall architecture of the platform. The system is composed of 3 main components, namely API layer, Event/Notification Backend (ENB), and Persistence Backend (PB). Persistence backend is where applications, their resources and event definitions are stored. All the data is persisted in this backend either to be used in ENB or to be exposed via API layer.

Clients and devices connect to the platform through the API layer using HTTP protocol. When a device pushes a data to its resource mapping, it, first, persisted in the system; then it is processes in the “event loop” to check if it triggers any events in the system. If an event is triggered, notifier sends this information all the clients subscribed to this event.



# API Endpoints
This section describes API endpoints with their example usages.

### Application Details
Returns the detail of an application, which is its resources and events.

Resource URL: 	/api/<app_name>
Request Method:	GET
Parameters:
    - app_name:	The name of the application

Example:
GET http://hostname/api/first-app/

Response:
```
{
  "modified": "2016-01-03T12:16:35.028Z",
  "data": {
    "resource": [
      {
        "name": "location",
        "url": "/api/first-app/resources/location/"
      },
      {
        "name": "pressure",
        "url": "/api/first-app/resources/pressure/"
      },
             "name": "light",
        "url": "/api/first-app/resources/light/"
      }
    ],
    "events": [
      {
        "name": "too-bright",
        "url": "/api/first-app/resources/light/events/too-bright/"
      }
    ]
  },
  "name": "first-app",
  "url": "/api/first-app/",
  "created": "2016-01-03T12:16:35.028Z"
}
```

### List Resources of an Application
Returns the detailed list of resources of an application.

Resource URL: 	/api/<app_name>/resources
Request Method:	GET
Parameters:
    - app_name:	The name of the application

Example:
GET http://hostname/api/first-app/resources/

Response:
```
[
  {
    "modified": "2016-01-03T16:45:19.310Z",
    "created": "2016-01-03T16:45:19.310Z",
    "url": "/api/first-app/resources/location/",
    "data": {
      "name": "location",
      "application": {
        "name": "first-app",
        "url": "/api/first-app/"
      },
      "data_fields": {
        "longitude": "float",
        "latitude": "float"
      }
    }
  },
  {
    "modified": "2016-01-03T16:35:58.765Z",
    "created": "2016-01-03T16:35:58.765Z",
    "url": "/api/first-app/resources/pressure/",
    "data": {
      "name": "pressure",
      "application": {
        "name": "first-app",
        "url": "/api/first-app/"
      },
      "data_fields": {
        "pressure": "float"
      }
    }
  },
  ...
]
```

### Create a Resource
Creates a resource for an application.

Resource URL: 	/api/<app_name>/resources
Request Method:	POST
Parameters:
    - app_name:	The name of the application

Example:
POST http://hostname/api/first-app/resources/

Request Body:
```
{
    “name”: “location”,
    "data_fields": {
        "longitude": "float",
        "latitude": "float"
    }
}
```

### Read a Resource
Returns the latest state of the resource.

Resource URL: 	/api/<app_name>/resources/<resource_name>/
Request Method:	GET
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource

Example:
GET http://hostname/api/first-app/resources/location/

Response:
```
{
   "longitude": 32.61575734242797,
   "latitude": 39.99219766817987
}
```

### Add Resource Data
Returns the latest state of the resource.

Resource URL: 	/api/<app_name>/resources/<resource_name>/
Request Method:	POST
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource

Example:
POST http://hostname/api/first-app/resources/location/

Request Body:
```
{
   "longitude": 32.61575734242797,
   "latitude": 39.99219766817987
}
```

### Create an Event For a Resource
Returns the latest state of the resource.

Resource URL: 	/api/<app_name>/resources/<resource_name>/events/
Request Method:	POST
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource

Example:
POST http://hostname/api/first-app/resources/light/events/

Request Body:
```
{
   "name": "too-bright"
   “condition”:[[“illuminance”, “gt”, 50]]
}
```

### List All Events for a Resource
Returns the detailed list of resources of an application.

Resource URL: 	/api/<app_name>/resources/<resource_name>/events/
Request Method:	GET
Parameters:
    - app_name:		The name of the application 	
    - resource_name: 	The name of the resource

Example:
GET http://hostname/api/first-app/resources/light/events/

Response:
```
[
  {
    "data": {
      "name": “too-bright",
      "resource": {
        "name": "light",
        "url": "/api/first-app/resources/light/"
      },
      "condition": [[“illuminance”, "gt", 0]],
      "application": {
        "name": "first-app",
        "url": "/api/first-app/"
      }
    },
    "url": “/api/first-app/resources/light/events/too-bright/",
    "created": "2016-01-14T23:18:16.861Z",
    "modified": "2016-01-14T23:18:16.861Z"
  }
]
```







### Update an Event
Update an existing event of the resource.

Resource URL: 	/api/<app_name>/resources/<resource_name>/events/<event_name>
Request Method:	PUT
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource 	
    - event_name: 	The name of the event

Example:
PUT http://hostname/api/first-app/resources/light/events/too-bright/

Request Body:
```
{
   “condition”:[[“illuminance”, “gt”, 80]]
}
```


### Subscribe to an Event
Subscribe to an existing event of the resource.

Resource URL:
/api/<app_name>/resources/<resource_name>/events/<event_name>/subscriptions
Request Method:	POST
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource 	
    - event_name: 	The name of the event

Example:
POST http://hostname/api/first-app/resources/light/events/too-bright/subscriptions

Request Body:
```
{
   “notify_url”: ”http://example.com/webhook/too-bright”
}
```

### Unsubscribe from an Event
Unsubscribe from an event of the resource.

Resource URL:
/api/<app_name>/resources/<resource_name>/events/<event_name>/subscriptions/<subs_id>
Request Method:	DELETE
Parameters:
    - app_name:		The name of the application
    - resource_name: 	The name of the resource 	
    - event_name: 	The name of the event
    - subs_id:		Id of the subscription

Example:
DELETE http://hostname/api/first-app/resources/light/events/too-bright/subscriptions/13
